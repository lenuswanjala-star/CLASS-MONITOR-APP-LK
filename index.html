<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class Monitor</title>
  <!-- React & Firebase CDNs -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.3/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="root">Loading...</div>

  <script type="text/javascript">
    const e = React.createElement;

    // -------------------- Firebase Config --------------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      document.getElementById("root").innerText = "Firebase initialization error: " + error;
      throw error;
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // -------------------- React App --------------------
    function App() {
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [user, setUser] = React.useState(null);
      const [role, setRole] = React.useState("");
      const [students, setStudents] = React.useState([]);
      const [studentName, setStudentName] = React.useState("");
      const [currentScreen, setCurrentScreen] = React.useState("dashboard");

      React.useEffect(() => {
        try {
          const unsubscribeAuth = auth.onAuthStateChanged(currentUser => {
            setUser(currentUser);
            setRole(currentUser ? (currentUser.email.includes("teacher") ? "teacher" : "student") : "");
            setLoading(false);
          });

          const unsubscribeStudents = db.collection("students").onSnapshot(snapshot => {
            setStudents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

          return () => {
            unsubscribeAuth();
            unsubscribeStudents();
          };
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      }, []);

      if (loading) return e('div', null, 'Loading Firebase...');
      if (error) return e('div', { style: { color: 'red' } }, 'Error: ' + error);

      const loginTeacher = () => auth.signInWithEmailAndPassword("teacher@example.com", "password123").catch(err => setError(err.message));
      const loginStudent = () => auth.signInWithEmailAndPassword("student@example.com", "password123").catch(err => setError(err.message));
      const logout = () => auth.signOut();

      const addStudent = () => {
        if (!studentName) return;
        db.collection("students").add({
          name: studentName,
          screen: "dashboard",
          attendance: "Absent",
          locked: false,
          lastActive: new Date().toISOString()
        }).catch(err => setError(err.message));
        setStudentName("");
      };

      const changeScreen = (screenName) => {
        setCurrentScreen(screenName);
        const studentDoc = students.find(s => s.name === user.email.split("@")[0]);
        if (studentDoc && !studentDoc.locked) {
          db.collection("students").doc(studentDoc.id).update({
            screen: screenName,
            lastActive: new Date().toISOString()
          }).catch(err => setError(err.message));
        }
      };

      const toggleLock = (studentId, lockState) => {
        db.collection("students").doc(studentId).update({ locked: lockState }).catch(err => setError(err.message));
      };

      if (!user) {
        return e('div', null,
          e('p', null, 'Login as:'),
          e('button', { onClick: loginTeacher }, 'Teacher'),
          e('button', { onClick: loginStudent }, 'Student'),
          error ? e('p', { style: { color: 'red' } }, error) : null
        );
      }

      if (role === "teacher") {
        return e('div', null,
          e('p', null, `Welcome, Teacher (${user.email})`),
          e('button', { onClick: logout }, 'Logout'),
          e('h2', null, 'Add Student'),
          e('input', { type: 'text', placeholder: 'Student name', value: studentName, onChange: e => setStudentName(e.target.value) }),
          e('button', { onClick: addStudent }, 'Add'),
          e('h2', null, 'Student Activity'),
          e('table', { border: 1, cellPadding: 5 },
            e('thead', null,
              e('tr', null,
                e('th', null, 'Name'),
                e('th', null, 'Current Screen'),
                e('th', null, 'Attendance'),
                e('th', null, 'Locked'),
                e('th', null, 'Actions')
              )
            ),
            e('tbody', null, students.map(s => e('tr', { key: s.id },
              e('td', null, s.name),
              e('td', null, s.screen),
              e('td', null, s.attendance),
              e('td', null, s.locked ? "Yes" : "No"),
              e('td', null,
                e('button', { onClick: () => toggleLock(s.id, !s.locked) }, s.locked ? "Unlock" : "Lock")
              )
            )))
          )
        );
      }

      const studentDoc = students.find(s => s.name === user.email.split("@")[0]);
      const isLocked = studentDoc?.locked || false;

      return e('div', null,
        e('p', null, `Welcome, Student (${user.email})`),
        e('button', { onClick: logout }, 'Logout'),
        e('h2', null, 'Student Dashboard'),
        e('p', null, `Current screen: ${currentScreen}`),
        isLocked ? e('p', { style: { color: 'red', fontWeight: 'bold' } }, 'Your screens are locked!') : null,
        e('button', { onClick: () => changeScreen("dashboard"), disabled: isLocked }, 'Dashboard'),
        e('button', { onClick: () => changeScreen("assignments"), disabled: isLocked }, 'Assignments'),
        e('button', { onClick: () => changeScreen("quiz"), disabled: isLocked }, 'Quiz')
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(e(App));
  </script>
</body>
</html>
